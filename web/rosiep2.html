<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>

    <title>Rosie P2</title>
    <link rel="stylesheet" href="rosieP2.css">
    <link rel="stylesheet" type="text/css" href="jqdialog.css"/>
    
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jqdialog.min.js"></script>
    
    <script type="text/javascript" src="../../blockly/blockly_compressed.js"></script>
    <script type="text/javascript" src="../../blockly/language/en/_messages.js"></script>
    <script type="text/javascript" src="../../blockly/generators/javascript.js"></script>
    
    <script type="text/javascript" src="language.js"></script>
    <script type="text/javascript" src="generator.js"></script>
    
    <script type="text/javascript">
    //-----------------------------------------------------------------------------------------
    // Global Level variables                                                                   
    //------------------------------------------------------------------------------------------
      var MAX_LEVEL = 7;
      var MIN_LEVEL = 1;
      var CURRENT_LEVEL = getLevel();
      var LEVELS_MSG = [" Rosie is going to a resturant with her friend, Jasmin. <BR/> &nbsp;&nbsp;&nbsp;&nbsp; Help her decide what to wear. ",
                        " Rosie is invited to a party. Dress code is white. <BR/> &nbsp;&nbsp;&nbsp;&nbsp; Help Rosie decide what to wear. ",
                        " Rosie wants to go to the gym. Jasmin invited her to go to brunch. Rosie is still hesitant on where to go. Help Rosie choose her outfit for both cases",
                        " Rosie want you to help her pick an outfit that would be her favorite to wear on formal occasions. define an outfit and use it",
                        " Rosie in invited to a formal event. She also has tickets for her favorite band concert.<BR/> Help Rosie on both cases",
                        " Rosie likes to have her bag and shoe of the same color. She picked the bag but not the shoe, pick a shoe and give it the same color",
                        " Rosie wore a top of a certain color, and wants you to pick a bottom that is different in color, pick a bottom and give it a different color"
                       ];
    
    
    //------------------------------------------------------------------------------------------
    // Attempt to open a web socket connection
    //------------------------------------------------------------------------------------------
    var socket = null;
    if ("WebSocket" in window) {
      socket = new WebSocket("ws://localhost:8080");
      socket.onopen    = function(evt) { console.log("HTML connected."); }
      socket.onmessage = function(evt) { processEvent(evt.data); }
      socket.onerror   = function(evt) { console.log("HTML error in server connection"); }
      socket.onclose   = function(evt) { console.log("HTML server connection closed."); }
      
    }
    
    //---------------------------------------------------------------------------
    //  Get level number from URL
    //---------------------------------------------------------------------------
    function getLevel () {
      var val = window.location.search.match(new RegExp('[?&]level=(\\d+)'));
      val = val ? val[1] : MIN_LEVEL;
      val = Math.min(Math.max(MIN_LEVEL, val), MAX_LEVEL);
      return val;
    }
    
    //---------------------------------------------------------------------------
    // Redirect to the next level
    //---------------------------------------------------------------------------
    function advanceLevel () {
      /*if (CURRENT_LEVEL < MAX_LEVEL) {
        var proceed = window.confirm('Congratulations!\nAre you ready to proceed to level %1?'.replace('%1', CURRENT_LEVEL + 1));
        if (proceed) {
          window.location = window.location.protocol + '//' +
          window.location.host + window.location.pathname +
          '?level=' + (CURRENT_LEVEL + 1);
        }
      } 
      else {
        window.alert("END OF GAME");
      }*/
      if (CURRENT_LEVEL < MAX_LEVEL) {
        $.jqDialog.confirm("Congratulations!<BR/> <BR/> Are you ready to proceed to level %1?".replace('%1', CURRENT_LEVEL + 1),
        function() { window.location = window.location.protocol + '//' +
                     window.location.host + window.location.pathname +
                     '?level=' + (CURRENT_LEVEL + 1); },    // callback function for 'YES' button
        
        function() {  }    // callback function for 'NO' button
        );  
      }
      
      else {
        $.jqDialog.alert("End of game", function() { }); // callback function for 'OK' button
      }   
      
      
    }
    
    function populate() {
      var COLORS = ['red', 'blue', 'gold', 'lime', 'black', 'pink', 'orange' , 'purple', 'grey'];
      for (var i=1; i < 9; i++ ) {
        for (var j=0; j < COLORS.length; j++ ) {
          var imgT=document.createElement("img");
          imgT.src = 'images/top'+ i + '-' + COLORS[j] +'.png';
          imgT.id = 'top'+ i + '-' + COLORS[j];
          imgT.className = 'top';
          document.getElementById("images").appendChild(imgT);
          
          var imgB=document.createElement("img");
          imgB.src = 'images/bottom'+ i + '-' + COLORS[j] +'.png';
          imgB.id = 'bottom'+ i + '-' + COLORS[j];
          imgB.className = 'bottom';
          document.getElementById("images").appendChild(imgB);
          //console.log(img.src);
          
        }
      }
    }
    
    //----------------------------------------------------------------------------------------
    // Inject blockly to this page and display the message corrosponding to the current level
    //----------------------------------------------------------------------------------------
    function inject() {
      populate();
      
      var toolbox = '<xml>';
      toolbox += '  <category></category>';
      
      toolbox += '  <category name="+ Tops"> <block type="top1"></block> <block type="top2"></block>';
      toolbox += '</category> <category> </category>'; //close tops
      
      toolbox += '<category name="+ Bottoms"> <block type="bottom1"></block> <block type="bottom2"></block>';
      toolbox += '</category> <category> </category>'; //close bottoms
      
      if (CURRENT_LEVEL > 1) {
        toolbox += '<category name="+ Coloring"> <block type="get_color_var"></block> <block type="red"></block> <block type="blue"></block>' + 
                    '<block type="black"></block> <block type="pink"></block> <block type="grey"></block> <block type="orange"></block> <block type="purple"></block>' +
                    '<block type="lime"></block> <block type="gold"></block>' ;
        toolbox += '</category> <category> </category>'; //close coloring
        if (CURRENT_LEVEL > 2) {
          toolbox += '<category name = "+ Controls"> <block type = "control_if"></block> <block type="going_to"></block> <block type="get_color_input"></block> <block type="control_repeat"></block>';
          toolbox += '</category> <category> </category>'; //close controls
          if (CURRENT_LEVEL > 3) {
            toolbox += '<category name = "+ Outfit Definitions" custom="PROCEDURE"></category>';
            toolbox += '</category> <category> </category>'; //close definitions*/
          }
        }  
      }
      
      toolbox += '</xml>';
      
      
      Blockly.inject(document.getElementById('rosie-code'), {path: '../../blockly/', toolbox: toolbox} );
      
      document.getElementById('full_text_div').innerHTML= LEVELS_MSG[CURRENT_LEVEL - 1];
      document.getElementById('level-h').innerHTML= "Level " + CURRENT_LEVEL + " :";
    }
    
    //---------------------------------------------------------------------------------------
    //                                                                                       
    //---------------------------------------------------------------------------------------
   
    
    function setHtmlOpacity(id, opacity) {
      var el = document.getElementById(id);
      if (el) {
         if (opacity > 0) {
            el.style.zIndex = 100;
         } else {
            el.style.zIndex = -1;
         }
         el.style.opacity = opacity;
      }
   }
   
   
   function fadeOutAfterDelay(id, delay) {
      window.setTimeout(function() { setHtmlOpacity(id, 0.0); }, delay);
   }
     
   function hideText() {
      document.getElementById('full_text_div').style.display='none';
      document.getElementById('more_btn').style.display='none';
      document.getElementById('part_text_div').style.display='inline';
   }
   
   function showText() {
      document.getElementById('more_btn').style.display='inline';
      document.getElementById('full_text_div').style.display='inline';
      document.getElementById('part_text_div').style.display='none';
   }    
   
    //---------------------------------------------------------------------------
    // Process dart event
    //---------------------------------------------------------------------------
    var playing = false;
    function processEvent(event) {
      //var button = document.getElementById("play-button");
      if (event == "@blockly DONE" ||
          event == "@blockly RESTARTED" ||
          event == "@blockly PAUSED") {
         //button.style.backgroundImage = 'url("images/play.png")';
         //playing = false;
         console.log("HTML received message from dart" + event);
         
      }
      else if (event == "@blockly GOT IT!") {
        console.log("HTML received message from dart " + event);
        
         //button.style.backgroundImage = 'url("images/pause.png")';
         //playing = true;
      }
      
       else if (event == "@blockly DONE!") {
        console.log("HTML received message from dart " + event);
        playing = false;
        window.setTimeout(function() { advanceLevel(); }, 500);
       }
    }
       
    
    function sendBlocklyCode() {
      if (!playing) {
        var code = Blockly.Generator.workspaceToCode('JavaScript');
        //--------------------------------------------------
        // error 1: no blocks on the screen
        //--------------------------------------------------
        if (code.length == 0) {
          setHtmlOpacity("hint1", 1.0);
          fadeOutAfterDelay("hint1", 4000);
        }
    
        //--------------------------------------------------
        // error 2: blocks aren't connected
        //--------------------------------------------------
        
        else if (code.indexOf("\n") >= 0) {
          setHtmlOpacity("hint2", 1.0);
          fadeOutAfterDelay("hint2", 4000);
        }
    
        else {
          code = code.replace(/\]\[/g, '], [');
          code = (code.replace(/\)/g, '')).replace(/\(/g, '');
          code = code.replace(/\;/g, '');
          if (socket != null && socket.readyState == 1) {
            //alert(code);
            socket.send('@dart '+ code);
            playing = true;
            //window.location.reload(true);
          }
        }
      }
    }
      
    </script>
       
  </head>
  <body onload="inject()">
    <img src="images/rosie.png" id="title">
    
    <div class="level-text">
      <div id="level-h" style="display:inline;"> </div> 
      <div id="full_text_div"  style="display:inline;"> </div>
      <!--<div id="more_btn"  style="display:inline;">
          <a href="JavaScript:void()"  onClick="hideText()" /> Show less...</a>
      </div>

      <div id="part_text_div"  style="display:none" > Level1
      <a href="JavaScript:void()"  onClick="showText()" /> Show more...</a>
      </div>-->

    </div>
       
    <div id="rosie-code" style="width: 900px; height: 815px;"></div>
    
           <!-- POPUP HINT TEXT -->
      <img src="images/hint1.png" id="hint1" class="hint">
      <img src="images/hint2.png" id="hint2" class="hint">
      
      <div id="images">
      <!--<img src="images/top1-red.png" id="top1-red" class="top">
      <img src="images/top1-blue.png" id="top1-blue" class="top">
      <img src="images/top1-grey.png" id="top1-grey" class="top">
      <img src="images/top1-black.png" id="top1-black" class="top">
      <img src="images/top1-gold.png" id="top1-gold" class="top">
      <img src="images/top1-pink.png" id="top1-pink" class="top">
      <img src="images/top1-purple.png" id="top1-purple" class="top">
      <img src="images/top1-lime.png" id="top1-lime" class="top">
      <img src="images/top1-orange.png" id="top1-orange" class="top">
      
      <img src="images/top2-red.png" id="top2-red" class="top">
      <img src="images/top2-blue.png" id="top2-blue" class="top">
      
      
      
      
      <img src="images/bottom1-red.png" id="bottom1-red" class="bottom">
      <img src="images/bottom1-blue.png" id="bottom1-blue" class="bottom">
      <img src="images/bottom1-grey.png" id="bottom1-grey" class="bottom">
      <img src="images/bottom1-black.png" id="bottom1-black" class="bottom">
      <img src="images/bottom1-gold.png" id="bottom1-gold" class="bottom">
      <img src="images/bottom1-pink.png" id="bottom1-pink" class="bottom">
      <img src="images/bottom1-purple.png" id="bottom1-purple" class="bottom">
      <img src="images/bottom1-lime.png" id="bottom1-lime" class="bottom">
      <img src="images/bottom1-orange.png" id="bottom1-orange" class="bottom">
      
      <img src="images/bottom2-red.png" id="bottom2-red" class="bottom">
      <img src="images/bottom2-blue.png" id="bottom2-blue" class="bottom">-->
      </div>
      <div id="rosie-output"> </div>

   <!-- TOOLBAR -->
   <div id="rosie-toolbar">
      <div>
         <button id="play-button" onclick="sendBlocklyCode();"></button>
      </div>
   </div>
   
    <script type="application/dart" src="rosieP2.dart"></script>
    <script src="packages/browser/dart.js"></script>
  </body>
</html>
