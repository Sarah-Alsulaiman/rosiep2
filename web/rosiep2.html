<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>

    <title>Rosie P2</title>
    <link rel="stylesheet" href="rosieP2.css">
    
    <script type="text/javascript" src="../../blockly/blockly_compressed.js"></script>
    <script type="text/javascript" src="../../blockly/language/en/_messages.js"></script>
    <script type="text/javascript" src="../../blockly/generators/javascript.js"></script>
    
    <script type="text/javascript" src="language.js"></script>
    <script type="text/javascript" src="generator.js"></script>
    
    <script type="text/javascript">
    //-----------------------------------------------------------------------------------------
    // Global Level variables                                                                   
    //------------------------------------------------------------------------------------------
      var MAX_LEVEL = 7;
      var MIN_LEVEL = 1;
      var CURRENT_LEVEL = getLevel();
      var LEVELS_MSG = [" Rosie is going to a resturant with her friend, Jasmin. <BR/> &nbsp;&nbsp;&nbsp;&nbsp; Help her decide what to wear. ",
                        " Rosie is invited to a party. Dress code is white. <BR/> &nbsp;&nbsp;&nbsp;&nbsp; Help Rosie decide what to wear. ",
                        " Rosie wants to go to the gym. Jasmin invited her to go to brunch. Rosie is still hesitant on where to go. Help Rosie choose her outfit for both cases",
                        " Rosie want you to help her pick an outfit that would be her favorite to wear on formal occasions. define an outfit and use it",
                        " Rosie in invited to a formal event. She also has tickets for her favorite band concert.<BR/> Help Rosie on both cases",
                        " Rosie likes to have her bag and shoe of the same color. She picked the bag but not the shoe, pick a shoe and give it the same color",
                        " Rosie wore a top of a certain color, and wants you to pick a bottom that is different in color, pick a bottom and give it a different color"
                       ];
    
    
    //------------------------------------------------------------------------------------------
    // Attempt to open a web socket connection
    //------------------------------------------------------------------------------------------
    var socket = null;
    if ("WebSocket" in window) {
      socket = new WebSocket("ws://localhost:8080");
      socket.onopen    = function(evt) { console.log("HTML connected."); }
      socket.onmessage = function(evt) { processEvent(evt.data); }
      socket.onerror   = function(evt) { console.log("HTML error in server connection"); }
      socket.onclose   = function(evt) { console.log("HTML server connection closed."); }
      
    }
    
    //---------------------------------------------------------------------------
    //  Get level number from URL
    //---------------------------------------------------------------------------
    function getLevel () {
      var val = window.location.search.match(new RegExp('[?&]level=(\\d+)'));
      val = val ? val[1] : MIN_LEVEL;
      val = Math.min(Math.max(MIN_LEVEL, val), MAX_LEVEL);
      return val;
    }
    
    //---------------------------------------------------------------------------
    // Redirect to the next level
    //---------------------------------------------------------------------------
    function advanceLevel () {
      if (CURRENT_LEVEL < MAX_LEVEL) {
        var proceed = window.confirm('Congratulations!\nAre you ready to proceed to level %1?'.replace('%1', CURRENT_LEVEL + 1));
        if (proceed) {
          window.location = window.location.protocol + '//' +
          window.location.host + window.location.pathname +
          '?level=' + (CURRENT_LEVEL + 1);
        }
      } 
      else {
        window.alert("END OF GAME");
      }
    
    }
    
    //----------------------------------------------------------------------------------------
    // Inject blockly to this page and display the message corrosponding to the current level
    //----------------------------------------------------------------------------------------
    function inject() {
      Blockly.inject(document.getElementById('rosie-code'),
      { path: '../../blockly/', toolbox: document.getElementById('toolbox' + CURRENT_LEVEL)} );
    
      document.getElementById('full_text_div').innerHTML= LEVELS_MSG[CURRENT_LEVEL - 1];
      document.getElementById('level-h').innerHTML= "Level " + CURRENT_LEVEL + " :";
    }
    
    //---------------------------------------------------------------------------------------
    //                                                                                       
    //---------------------------------------------------------------------------------------
   
    
    function setHtmlOpacity(id, opacity) {
      var el = document.getElementById(id);
      if (el) {
         if (opacity > 0) {
            el.style.zIndex = 100;
         } else {
            el.style.zIndex = -1;
         }
         el.style.opacity = opacity;
      }
   }
   
   
   function fadeOutAfterDelay(id, delay) {
      window.setTimeout(function() { setHtmlOpacity(id, 0.0); }, delay);
   }
     
   function hideText() {
      document.getElementById('full_text_div').style.display='none';
      document.getElementById('more_btn').style.display='none';
      document.getElementById('part_text_div').style.display='inline';
   }
   
   function showText() {
      document.getElementById('more_btn').style.display='inline';
      document.getElementById('full_text_div').style.display='inline';
      document.getElementById('part_text_div').style.display='none';
   }    
   
    //---------------------------------------------------------------------------
    // Process dart event
    //---------------------------------------------------------------------------
    function processEvent(event) {
      //var button = document.getElementById("play-button");
      if (event == "@blockly DONE" ||
          event == "@blockly RESTARTED" ||
          event == "@blockly PAUSED") {
         //button.style.backgroundImage = 'url("images/play.png")';
         //playing = false;
         console.log("HTML received message from dart" + event);
         
      }
      else if (event == "@blockly GOT IT!") {
        console.log("HTML received message from dart " + event);
        
         //button.style.backgroundImage = 'url("images/pause.png")';
         //playing = true;
      }
      
       else if (event == "@blockly DONE!") {
        console.log("HTML received message from dart " + event);
        advanceLevel();
        
       }
    }
       
       
    function sendBlocklyCode() {
      var code = Blockly.Generator.workspaceToCode('JavaScript');
      //--------------------------------------------------
     // error 1: no blocks on the screen
     //--------------------------------------------------
      if (code.length == 0) {
        setHtmlOpacity("hint1", 1.0);
        fadeOutAfterDelay("hint1", 4000);
      }
  
      //--------------------------------------------------
      // error 2: blocks aren't connected
      //--------------------------------------------------
      
       else if (code.indexOf("\n") >= 0) {
            setHtmlOpacity("hint2", 1.0);
            fadeOutAfterDelay("hint2", 4000);
         }
  
      else {
        code = code.replace(/\]\[/g, '], [');
        code = (code.replace(/\)/g, '')).replace(/\(/g, '');
        code = code.replace(/\;/g, '');
      }
        if (socket != null && socket.readyState == 1) {
        //alert(code);
        socket.send('@dart '+ code);
        
        //window.location.reload(true);
        }
      
    }
      
    </script>
       
  </head>
  <body onload="inject()">
    <img src="images/rosie.png" id="title">
    
    <div class="level-text">
      <div id="level-h" style="display:inline;"> </div> 
      <div id="full_text_div"  style="display:inline;"> </div>
      <!--<div id="more_btn"  style="display:inline;">
          <a href="JavaScript:void()"  onClick="hideText()" /> Show less...</a>
      </div>

      <div id="part_text_div"  style="display:none" > Level1
      <a href="JavaScript:void()"  onClick="showText()" /> Show more...</a>
      </div>-->

    </div>
       
    <div id="rosie-code" style="width: 900px; height: 815px;"></div>
    
    
     <xml id="toolbox1" style="display: none">
       <category> </category>
       <category name="+ Tops">
         <block type="top1"></block>
         <block type="top2"></block>
       </category>
       <category> </category>
       <category name="+ Bottoms">
         <block type="bottom1"></block>
         <block type="bottom2"></block>
       </category>
       <category></category>
       <category name="+ Coloring">
         <block type="get_color_input"></block>
         <block type="get_color_var"></block>
         <block type="red"></block>
         <block type="blue"></block>
       </category>
       <category></category>
       <category name = "+ Controls">
         <block type = "control_if"></block>
         <block type="going_to"></block>   
         <block type="control_repeat"></block>
       </category>
       <category></category>
       <category name = "+ Outfit Definitions" custom="PROCEDURE"></category>
       <category></category>
       <category name = "+ VARS" > </category>
         
   </xml>

  <xml id="toolbox" style="display: none">
  <block type="controls_if" inline="false" x="321" y="155">
    <value name="IF0">
      <block type="logic_compare" inline="true">
        <title name="OP">EQ</title>
        <value name="A">
          <block type="colour_picker">
            <title name="COLOUR">#ffffff</title>
          </block>
        </value>
        <value name="B">
          <block type="colour_random"></block>
        </value>
      </block>
    </value>
    <statement name="DO0">
      <block type="math_change" inline="false">
        <title name="VAR">item</title>
        <value name="DELTA">
          <block type="math_number">
            <title name="NUM">1</title>
          </block>
        </value>
      </block>
    </statement>
  </block>
</xml> <!---->
  
     
       <!-- POPUP HINT TEXT -->
      <img src="images/hint1.png" id="hint1" class="hint">
      <img src="images/hint2.png" id="hint2" class="hint">
      
      
      <img src="images/top1-red.png" id="top1-red" class="top">
      <img src="images/top2-red.png" id="top2-red" class="top">
      <img src="images/top1-blue.png" id="top1-blue" class="top">
      <img src="images/top2-blue.png" id="top2-blue" class="top">
      
      
      <img src="images/bottom1-red.png" id="bottom1-red" class="bottom">
      <img src="images/bottom2-red.png" id="bottom2-red" class="bottom">
      <img src="images/bottom1-blue.png" id="bottom1-blue" class="bottom">
      <img src="images/bottom2-blue.png" id="bottom2-blue" class="bottom">
      
      <div id="rosie-output"> </div>

   <!-- TOOLBAR -->
   <div id="rosie-toolbar">
      <div>
         <button id="play-button" onclick="sendBlocklyCode();"></button>
      </div>
   </div>
   
    <script type="application/dart" src="rosieP2.dart"></script>
    <script src="packages/browser/dart.js"></script>
  </body>
</html>
